#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ” Generating schema.sql from migration files..."

# Create temporary database
TEMP_DB="temp_schema_dump.db"
rm -f "$TEMP_DB"

# Create database directory
mkdir -p db

echo "ðŸ“ Creating temporary database and applying migrations..."

# Create empty database and apply migrations using sqlx
DATABASE_URL="sqlite:$TEMP_DB" sqlx database create
DATABASE_URL="sqlite:$TEMP_DB" sqlx migrate run

# Dump the schema using sqlite3
echo "ðŸ“¤ Dumping schema..."
SCHEMA=$(sqlite3 "$TEMP_DB" ".schema")

# Generate schema.sql with header
cat >db/schema.sql <<EOF
-- This file is auto-generated from the current database schema.
-- Do not edit this file directly. Instead, create a new migration.
--
-- Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
-- Database version: (determined by migration files in migrations/)
--
-- To regenerate this file, run:
--   ./bin/dump-schema.sh

$SCHEMA
EOF

# Show summary
echo "âœ… Schema dumped to db/schema.sql"
echo "ðŸ“Š Current schema includes:"

# List tables
sqlite3 "$TEMP_DB" ".tables" | tr ' ' '\n' | grep -v '^$' | sed 's/^/   - /'

# Clean up
rm -f "$TEMP_DB"

echo "ðŸŽ‰ Schema dump complete!"
